<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Summer Campground Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-container {
            padding: 2rem 0;
        }
        .search-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .result-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }
        .result-card:hover {
            transform: translateY(-2px);
        }
        .weather-icon {
            font-size: 2rem;
            color: #f39c12;
        }
        .distance-badge {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
        }
        .temp-badge {
            background: linear-gradient(45deg, #fa709a 0%, #fee140 100%);
        }
        .loading-spinner {
            display: none;
        }
        .header-title {
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        .btn-search {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 10px 30px;
            font-weight: 600;
        }
        .btn-search:hover {
            background: linear-gradient(45deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-1px);
        }
        .no-results {
            text-align: center;
            color: #6c757d;
            padding: 3rem;
        }
        .city-dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .city-dropdown-item:hover {
            background-color: #f8f9fa;
        }
        .city-dropdown-item:last-child {
            border-bottom: none;
        }
        .city-name {
            font-weight: 600;
            color: #495057;
        }
        .city-details {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .city-dropdown-loading {
            padding: 10px 15px;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container main-container">
        <header class="text-center mb-5">
            <h1 class="display-4 header-title">
                <i class="bi bi-sun"></i> Summer Seeker
            </h1>
            <p class="lead text-white">Discover campgrounds with perfect weather within your preferred distance from home</p>
        </header>

        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="card search-card">
                    <div class="card-body p-4">
                        <form id="searchForm">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="city_search" class="form-label">
                                        <i class="bi bi-house"></i> Your Home City
                                    </label>
                                    <div class="position-relative">
                                        <input type="text" class="form-control" id="city_search" 
                                               placeholder="Enter your home city to find nearby campgrounds..." autocomplete="off" required>
                                        <div id="city_dropdown" class="position-absolute w-100 bg-white border border-top-0 rounded-bottom" 
                                             style="max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
                                        </div>
                                    </div>
                                    <small class="text-muted">We'll find campgrounds within your specified distance from your home location</small>
                                    <!-- Hidden fields to store coordinates -->
                                    <input type="hidden" id="home_lat" name="home_lat">
                                    <input type="hidden" id="home_long" name="home_long">
                                </div>
                                <div class="col-md-3">
                                    <label for="max_miles" class="form-label">
                                        <i class="bi bi-signpost-2"></i> Max Distance
                                    </label>
                                    <input type="number" class="form-control" id="max_miles" 
                                           value="400" min="10" max="1000" required>
                                    <small class="text-muted">Miles from home</small>
                                </div>
                                <div class="col-md-4">
                                    <label for="min_high_temp" class="form-label">
                                        <i class="bi bi-thermometer-half"></i> Min Temp (°F)
                                    </label>
                                    <input type="number" class="form-control" id="min_high_temp" 
                                           value="70" min="50" max="90" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="max_high_temp" class="form-label">
                                        <i class="bi bi-thermometer-sun"></i> Max Temp (°F)
                                    </label>
                                    <input type="number" class="form-control" id="max_high_temp" 
                                           value="88" min="70" max="100" required>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-check mt-3">
                                        <input class="form-check-input" type="checkbox" id="prefer_waterfront">
                                        <label class="form-check-label" for="prefer_waterfront">
                                            <i class="bi bi-water"></i> Prefer waterfront campgrounds
                                        </label>
                                        <small class="text-muted d-block">Show lake, river, ocean, and other waterfront campsites first</small>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="form-check mt-3">
                                        <input class="form-check-input" type="checkbox" id="all_days">
                                        <label class="form-check-label" for="all_days">
                                            <i class="bi bi-calendar-week"></i> Include all days of the week
                                        </label>
                                        <small class="text-muted d-block">Search all days instead of just weekends (Saturday, Sunday)</small>
                                    </div>
                                </div>
                                <div class="col-12 text-center">
                                    <button type="submit" class="btn btn-primary btn-search">
                                        <i class="bi bi-search"></i> Find Campgrounds Near Home
                                    </button>
                                    <div class="loading-spinner mt-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Searching...</span>
                                        </div>
                                        <p class="mt-2 text-muted" id="progressText">Checking weather at campgrounds...</p>
                                        <div class="progress mt-2" style="height: 6px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" role="progressbar" style="width: 0%"></div>
                                        </div>
                                        <div class="mt-3" id="progressLog" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; background: #f8f9fa; padding: 10px; border-radius: 5px; display: none;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="resultsContainer" class="row">
            <!-- Results will be loaded here -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // City autocomplete functionality
        let searchTimeout;
        const citySearchInput = document.getElementById('city_search');
        const cityDropdown = document.getElementById('city_dropdown');
        const homeLatInput = document.getElementById('home_lat');
        const homeLongInput = document.getElementById('home_long');

        citySearchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            // Clear previous timeout
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                hideDropdown();
                return;
            }
            
            // Show loading state
            showDropdown('<div class="city-dropdown-loading">Searching...</div>');
            
            // Debounce search requests
            searchTimeout = setTimeout(() => {
                searchCities(query);
            }, 300);
        });

        citySearchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 2) {
                searchCities(this.value.trim());
            }
        });

        document.addEventListener('click', function(e) {
            if (!citySearchInput.contains(e.target) && !cityDropdown.contains(e.target)) {
                hideDropdown();
            }
        });

        async function searchCities(query) {
            try {
                const response = await fetch(`/geocode?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.error) {
                    showDropdown('<div class="city-dropdown-loading">Error: ' + data.error + '</div>');
                    return;
                }
                
                if (data.length === 0) {
                    showDropdown('<div class="city-dropdown-loading">No cities found</div>');
                    return;
                }
                
                let dropdownHTML = '';
                data.forEach(city => {
                    const displayName = [city.name, city.admin1, city.country].filter(Boolean).join(', ');
                    
                    dropdownHTML += `
                        <div class="city-dropdown-item" 
                             data-lat="${city.latitude}" 
                             data-lon="${city.longitude}" 
                             data-name="${city.name}"
                             data-admin1="${city.admin1 || ''}"
                             data-country="${city.country || ''}">
                            <div class="city-name">${city.name}</div>
                            <div class="city-details">${displayName}</div>
                        </div>
                    `;
                });
                
                showDropdown(dropdownHTML);
                
                // Add click handlers to dropdown items
                document.querySelectorAll('.city-dropdown-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const city = {
                            latitude: this.dataset.lat,
                            longitude: this.dataset.lon,
                            name: this.dataset.name,
                            admin1: this.dataset.admin1,
                            country: this.dataset.country
                        };
                        
                        selectCity(city);
                    });
                });
                
            } catch (error) {
                showDropdown('<div class="city-dropdown-loading">Search failed</div>');
            }
        }

        function selectCity(city) {
            // Populate the hidden coordinate fields
            document.getElementById('home_lat').value = city.latitude;
            document.getElementById('home_long').value = city.longitude;
            
            // Build full city display string
            let cityDisplay = city.name;
            if (city.admin1 && city.admin1 !== city.name) {
                cityDisplay += ', ' + city.admin1;
            }
            if (city.country && city.country !== 'US') {
                cityDisplay += ', ' + city.country;
            }
            
            // Set the input field to the full city information
            document.getElementById('city_search').value = cityDisplay;
            
            // Clear validation state and add valid state
            document.getElementById('city_search').classList.remove('is-invalid');
            document.getElementById('city_search').classList.add('is-valid');
            
            hideDropdown();
        }

        function showDropdown(content) {
            cityDropdown.innerHTML = content;
            cityDropdown.style.display = 'block';
        }

        function hideDropdown() {
            cityDropdown.style.display = 'none';
        }

        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validate that a city has been selected (coordinates are filled)
            const cityInput = document.getElementById('city_search');
            const latInput = document.getElementById('home_lat');
            const longInput = document.getElementById('home_long');
            
            // Clear previous validation states
            cityInput.classList.remove('is-invalid', 'is-valid');
            
            let isValid = true;
            
            // Check if coordinates are filled (city was selected)
            const latValue = latInput.value.trim();
            const longValue = longInput.value.trim();
            
            if (!latValue || !longValue || isNaN(parseFloat(latValue)) || isNaN(parseFloat(longValue))) {
                cityInput.classList.add('is-invalid');
                isValid = false;
                
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-3';
                errorDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Please select a city from the dropdown to set your home location.';
                
                // Remove any existing error message
                const existingError = document.querySelector('.alert-danger');
                if (existingError) {
                    existingError.remove();
                }
                
                // Add new error message
                cityInput.closest('.row').appendChild(errorDiv);
                
                // Remove error message after 5 seconds
                setTimeout(() => {
                    if (errorDiv.parentNode) {
                        errorDiv.remove();
                    }
                }, 5000);
                
                return;
            }
            
            cityInput.classList.add('is-valid');
            
            // Remove any existing error message
            const existingError = document.querySelector('.alert-danger');
            if (existingError) {
                existingError.remove();
            }
            
            const formData = {
                home_lat: parseFloat(latValue),
                home_long: parseFloat(longValue),
                max_miles: document.getElementById('max_miles').value,
                min_high_temp: document.getElementById('min_high_temp').value,
                max_high_temp: document.getElementById('max_high_temp').value,
                prefer_waterfront: document.getElementById('prefer_waterfront').checked,
                all_days: document.getElementById('all_days').checked
            };
            
            // Show loading spinner and progress elements
            document.querySelector('.loading-spinner').style.display = 'block';
            document.getElementById('progressLog').style.display = 'block';
            document.getElementById('progressLog').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('resultsContainer').innerHTML = '';
            
            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error('Search request failed');
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const message = line.slice(6);
                            
                            if (message.startsWith('SEARCH_COMPLETE:')) {
                                const results = JSON.parse(message.slice('SEARCH_COMPLETE:'.length));
                                document.querySelector('.loading-spinner').style.display = 'none';
                                displayResults(results);
                                break;
                            } else if (message.startsWith('ERROR:')) {
                                const error = message.slice('ERROR:'.length);
                                document.querySelector('.loading-spinner').style.display = 'none';
                                displayError(error);
                                break;
                            } else if (message.includes('Checking')) {
                                const match = message.match(/Checking (.+) \((\d+)\/(\d+)\)/);
                                if (match) {
                                    const [, name, current, total] = match;
                                    const progress = (parseInt(current) / parseInt(total)) * 100;
                                    document.getElementById('progressBar').style.width = progress + '%';
                                    document.getElementById('progressText').textContent = `Checking ${name} (${current}/${total})`;
                                }
                            } else if (message.includes('Found summer day')) {
                                document.getElementById('progressText').textContent = message;
                            } else if (message.includes('Error fetching weather')) {
                                document.getElementById('progressText').textContent = message;
                            }
                            
                            // Add to progress log
                            const logEntry = document.createElement('div');
                            logEntry.textContent = message;
                            logEntry.style.color = message.includes('Error') ? '#dc3545' : 
                                                 message.includes('Found summer day') ? '#28a745' : '#6c757d';
                            document.getElementById('progressLog').appendChild(logEntry);
                            document.getElementById('progressLog').scrollTop = document.getElementById('progressLog').scrollHeight;
                        }
                    }
                }
            } catch (error) {
                document.querySelector('.loading-spinner').style.display = 'none';
                displayError('An error occurred while searching. Please try again.');
            }
        });
        
        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            
            if (results.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="card result-card">
                            <div class="card-body no-results">
                                <i class="bi bi-cloud-sun" style="font-size: 3rem; color: #6c757d;"></i>
                                <h4>No Perfect Summer Weekends Found Near Your Home</h4>
                                <p>Try adjusting your search criteria or expanding the distance from your home location.</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            let resultsHTML = '<div class="col-12"><h3 class="text-white mb-4">Found ' + results.length + ' Perfect Summer Weekends Near Your Home</h3></div>';
            
            results.forEach((result, index) => {
                const waterfrontBadge = result.waterfront && result.waterfront !== 'none' 
                    ? `<span class="badge bg-info text-white ms-2"><i class="bi bi-water"></i> ${result.waterfront}front</span>`
                    : '';
                
                resultsHTML += `
                    <div class="col-lg-6 col-xl-4 mb-4">
                        <div class="card result-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title mb-0">${result.name}${waterfrontBadge}</h5>
                                    <span class="badge distance-badge text-white">
                                        <i class="bi bi-geo-alt"></i> ${result.dist} mi
                                    </span>
                                </div>
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-calendar-event weather-icon me-2"></i>
                                    <div>
                                        <h6 class="mb-0">${result.day}</h6>
                                        <small class="text-muted">${result.date}</small>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="badge temp-badge text-white me-2">
                                        <i class="bi bi-thermometer-sun"></i> ${result.temp}°F
                                    </span>
                                    <small class="text-muted">Perfect summer weather!</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = resultsHTML;
        }
        
        function displayError(error) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `
                <div class="col-12">
                    <div class="card result-card">
                        <div class="card-body text-center text-danger">
                            <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                            <h4 class="mt-3">Search Error</h4>
                            <p>${error}</p>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
